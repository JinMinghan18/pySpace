import time
import requests
from pyquery import PyQuery as pq
import MySQLdb

def getHTML(url,params):
    header = {'User-Agent' : "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebkit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36"}
    html = requests.get(url,params=params,headers=header)
    # print(html.encoding)
    html.encoding = html.apparent_encoding
    # print(html.encoding)
    return html.text

url = "http://www.nsfocus.net/index.php"

params = {"act": "sec_bug",
          "type_id": "",
          "os": "",
          "keyword": "",
          "page": 3
          }

db = MySQLdb.connect('localhost','root','admin','crawler',charset='utf8')
cursor = db.cursor()
error_txt = open('error.txt','w+',encoding='utf-8')

for i in range(1308,3156):

    params['page'] = i+1
    html = getHTML(url,params)
    doc = pq(html)
    ul = doc('.vul_list')

    sql = 'Insert Into NSFOCUS_vulnerability Values\n'

    for li in ul.children().items():
        tmp = "("
        date = li('span').text()
        abstract = li('a').text()
        href = li('a').attr('href')
        tmp = tmp + "'" + date + "',"
        tmp = tmp + "'" + abstract.replace("'","\\'") + "',"
        tmp = tmp + "'" + href.replace("'","\\'") + "'),\n"
        sql = sql + tmp
    
    sql = sql[0:len(sql)-2]

    try:
        cursor.execute(sql)
        db.commit()
    except:
        print("Failed to insert db")
        error_txt.write(i+1)
        error_txt.write("\n")
        error_txt.write(sql)
        error_txt.write("\n\n\n\n")
        break
        
    print("第{}页已经爬取到数据库".format(i+1))
    time.sleep(10)
    print("睡眠结束")

pause
db.close()
error_txt.close() + "),\n"

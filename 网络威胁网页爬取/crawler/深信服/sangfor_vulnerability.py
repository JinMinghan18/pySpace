import requests
from pyquery import PyQuery as pq
import time
import MySQLdb
import json

def getHTML(url,form_data):
    header = {'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64} AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36'}
    # cookies = {'Cookie':'Cookie: sessionid=0ahlzi2bjuqul6ansiv0lhmb4ggxgdwo; UEDC_LOGIN_LANGUAGE=cn'}
    html = requests.get(url,params = form_data,headers=header)
    html.encoding = html.apparent_encoding
    return html.text

data = {
    "has_activity_average":"",
    "has_exp":"",
    "has_discover_detail":"",
    "has_poc":"",
    "search_field":"",
    "vuln_level":"",
    "vuln_type":"",
    "start_time":"",
    "end_time":"",
    "page_index":2,
    "page_size":60,
    "sort_order":-1,
    "sort_field":"vuln_discover_date",
    "vuln_object":""
}

url = "https://sec.sangfor.com.cn/api/v1/vuln_wiki/get_vuln_list"

db =MySQLdb.connect('localhost','root','123456','crawler',charset='utf8')
cursor = db.cursor()

# with open('2.txt','r',encoding='utf-8') as f:
#     html = f.read()

for i in range(435,436):

    data["page_index"] = i + 1
    html = getHTML(url,data)

    res = json.loads(html)["data"]

    sql = 'Insert into sangfor_vulnerability Values\n'

    for it in res:
        tmp = "("
        for it2 in it:
            if type(it[it2]) is str:
                if it2 == "vuln_level":
                    if it[it2] == "103":
                        tmp = tmp + "'严重',"
                    elif it[it2] == "102":
                        tmp = tmp + "'高危',"
                    elif it[it2] == "101":
                        tmp = tmp + "'中危',"
                    elif it[it2] == "100":
                        tmp = tmp + "'低危',"
                    elif it[it2] == "":
                        tmp = tmp + "'未知',"
                else:
                    tmp = tmp + "'" + it[it2].replace("'","\\'") + "',"
            elif type(it[it2]) is int:
                tmp = tmp + str(it[it2]) + ","
            elif type(it[it2]) is list:
                l = it[it2]
                sta = ""
                if l[0] == 1:
                    sta = sta + "有披露详情/"
                if l[1] == 1:
                    sta = sta + "无PoC/"
                if l[2] == 1:
                    sta = sta + "无Exp/"
                if l[3] == 1:
                    sta = sta + "无态势图/"
                tmp = tmp + "'" + sta[0:len(sta)-1] + "',"
            elif type(it[it2]) is dict:
                for it3 in it[it2]:
                    tmp = tmp + "'" + it[it2][it3] + "',"
            # print(it[it2])
            # print(type(it[it2]))
        
        tmp = tmp[0:len(tmp)-1] + "),\n"
        sql = sql + tmp
        # print(tmp)

    sql = sql[0:len(sql)-2]
    try:
        cursor.execute(sql)
        db.commit()
    except:
        print("Failed to insert db")
        with open('error.txt','a',encoding='utf-8') as f:
            f.write(i+1)
            f.write("\n")
            f.write(sql)
            f.write("\n\n\n")

    print("第{}页已经爬取到数据库".format(i+1))
    time.sleep(10)
    print("睡眠结束")

sb.close()